"""
=============================================================================
DataLoader ä½¿ç”¨æ¼”ç¤º
=============================================================================
æœ¬æ–‡ä»¶æ¼”ç¤ºäº† PyTorch DataLoader çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ã€‚

ğŸ“š æ ¸å¿ƒæ¦‚å¿µï¼š
    - Dataset: å­˜å‚¨æ•°æ®æ ·æœ¬å’Œå¯¹åº”æ ‡ç­¾çš„æŠ½è±¡ç±»
    - DataLoader: å°† Dataset å°è£…æˆå¯è¿­ä»£å¯¹è±¡ï¼Œæä¾›æ‰¹é‡åŠ è½½ã€æ‰“ä¹±ã€å¹¶è¡ŒåŠ è½½ç­‰åŠŸèƒ½

ğŸ”— DataLoader çš„ä½œç”¨ï¼š
    1. è‡ªåŠ¨å°†æ•°æ®åˆ†æˆ batchï¼ˆæ‰¹æ¬¡ï¼‰
    2. å¯é€‰æ‹©æ˜¯å¦æ‰“ä¹±æ•°æ®é¡ºåº
    3. æ”¯æŒå¤šè¿›ç¨‹å¹¶è¡ŒåŠ è½½æ•°æ®
    4. è‡ªåŠ¨å¤„ç†æœ€åä¸€ä¸ªä¸å®Œæ•´çš„ batch

ä»åŸ dataloader.py è¿ç§»
=============================================================================
"""
import sys
import os

# ============================================================================
# è·¯å¾„è®¾ç½®
# ============================================================================
# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„ï¼Œç¡®ä¿å¯ä»¥å¯¼å…¥ src æ¨¡å—
# os.path.abspath(__file__) è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
# os.path.dirname() è·å–çˆ¶ç›®å½•ï¼Œè°ƒç”¨ä¸¤æ¬¡å¾—åˆ°é¡¹ç›®æ ¹ç›®å½•
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# ============================================================================
# å¯¼å…¥ä¾èµ–
# ============================================================================
from torch.utils.tensorboard import SummaryWriter  # TensorBoard å¯è§†åŒ–å·¥å…·
import torchvision                                  # è®¡ç®—æœºè§†è§‰å·¥å…·åŒ…
from torch.utils.data import DataLoader            # æ•°æ®åŠ è½½å™¨


def main():
    """
    ä¸»å‡½æ•°ï¼šæ¼”ç¤º DataLoader çš„å®Œæ•´ä½¿ç”¨æµç¨‹
    """
    
    # ========================================================================
    # 1. å‡†å¤‡æ•°æ®é›† (Dataset)
    # ========================================================================
    # CIFAR10 æ•°æ®é›†ï¼šåŒ…å« 60000 å¼  32x32 å½©è‰²å›¾åƒï¼Œåˆ†ä¸º 10 ä¸ªç±»åˆ«
    # - è®­ç»ƒé›†ï¼š50000 å¼ 
    # - æµ‹è¯•é›†ï¼š10000 å¼ 
    test_data = torchvision.datasets.CIFAR10(
        root="../datasets",                           # æ•°æ®é›†å­˜å‚¨è·¯å¾„
        train=False,                                  # False=æµ‹è¯•é›†, True=è®­ç»ƒé›†
        transform=torchvision.transforms.ToTensor(), # å°† PIL Image è½¬ä¸º Tensor
        download=True                                 # å¦‚æœæ•°æ®ä¸å­˜åœ¨åˆ™è‡ªåŠ¨ä¸‹è½½
    )

    # ========================================================================
    # 2. åˆ›å»º DataLoader
    # ========================================================================
    # DataLoader å°† Dataset åŒ…è£…æˆå¯è¿­ä»£å¯¹è±¡ï¼Œæ¯æ¬¡è¿­ä»£è¿”å›ä¸€ä¸ª batch
    test_loader = DataLoader(
        dataset=test_data,   # è¦åŠ è½½çš„æ•°æ®é›†
        batch_size=64,       # æ¯ä¸ª batch åŒ…å«çš„æ ·æœ¬æ•°é‡
                             # - è¾ƒå¤§çš„ batch_size: è®­ç»ƒæ›´ç¨³å®šï¼Œä½†éœ€è¦æ›´å¤šæ˜¾å­˜
                             # - è¾ƒå°çš„ batch_size: è®­ç»ƒéœ‡è¡å¤§ï¼Œä½†æ³›åŒ–å¯èƒ½æ›´å¥½
        shuffle=True,        # æ˜¯å¦åœ¨æ¯ä¸ª epoch å¼€å§‹æ—¶æ‰“ä¹±æ•°æ®
                             # - è®­ç»ƒæ—¶é€šå¸¸è®¾ä¸º Trueï¼Œé¿å…æ¨¡å‹å­¦ä¹ åˆ°æ•°æ®é¡ºåº
                             # - æµ‹è¯•/éªŒè¯æ—¶é€šå¸¸è®¾ä¸º False
        num_workers=0,       # åŠ è½½æ•°æ®çš„å­è¿›ç¨‹æ•°é‡
                             # - 0: åœ¨ä¸»è¿›ç¨‹ä¸­åŠ è½½ï¼ˆWindows ä¸‹å»ºè®®ç”¨ 0ï¼‰
                             # - >0: ä½¿ç”¨å¤šè¿›ç¨‹å¹¶è¡ŒåŠ è½½ï¼Œå¯åŠ é€Ÿæ•°æ®è¯»å–
        drop_last=False      # æ˜¯å¦ä¸¢å¼ƒæœ€åä¸€ä¸ªä¸å®Œæ•´çš„ batch
                             # - False: ä¿ç•™æœ€åä¸€ä¸ª batchï¼ˆå¯èƒ½å°‘äº batch_sizeï¼‰
                             # - True: ä¸¢å¼ƒæœ€åä¸€ä¸ªä¸å®Œæ•´çš„ batch
    )

    # ========================================================================
    # 3. æŸ¥çœ‹å•ä¸ªæ ·æœ¬çš„ä¿¡æ¯
    # ========================================================================
    # ç›´æ¥ä» Dataset ä¸­å–å‡ºç¬¬ä¸€ä¸ªæ ·æœ¬
    img, target = test_data[0]
    print(f"Image Shape: {img.shape}")   # è¾“å‡º: torch.Size([3, 32, 32])
                                          # æ ¼å¼: [é€šé“æ•°C, é«˜åº¦H, å®½åº¦W]
    print(f"Target Label: {target}")      # è¾“å‡º: ç±»åˆ«æ ‡ç­¾ (0-9 çš„æ•´æ•°)

    # ========================================================================
    # 4. åˆå§‹åŒ– TensorBoard æ—¥å¿—è®°å½•å™¨
    # ========================================================================
    # SummaryWriter ç”¨äºå°†æ•°æ®å†™å…¥ TensorBoard å¯è§†åŒ–
    # å‚æ•°ä¸ºæ—¥å¿—ä¿å­˜çš„ç›®å½•å
    writer = SummaryWriter("dataloader")

    # ========================================================================
    # 5. æ¨¡æ‹Ÿè®­ç»ƒå¾ªç¯ - æ¼”ç¤ºå¦‚ä½•éå† DataLoader
    # ========================================================================
    # å¤–å±‚å¾ªç¯ï¼šéå† epochï¼ˆå®Œæ•´éå†ä¸€æ¬¡æ•°æ®é›†ç§°ä¸ºä¸€ä¸ª epochï¼‰
    for epoch in range(2):
        step = 0  # è®°å½•å½“å‰ batch çš„åºå·
        
        # å†…å±‚å¾ªç¯ï¼šéå† DataLoader ä¸­çš„æ¯ä¸ª batch
        # æ¯æ¬¡è¿­ä»£è¿”å›ä¸€ä¸ª batch çš„æ•°æ®
        for data in test_loader:
            # data æ˜¯ä¸€ä¸ªå…ƒç»„: (images, labels)
            # imgs: shape = [batch_size, 3, 32, 32] ä¸€æ‰¹å›¾åƒ
            # targets: shape = [batch_size] å¯¹åº”çš„æ ‡ç­¾
            imgs, targets = data
            
            # å°†å›¾åƒå†™å…¥ TensorBoard
            # add_images(tag, img_tensor, global_step)
            # - tag: å›¾åƒçš„æ ‡ç­¾åç§°
            # - img_tensor: å›¾åƒå¼ é‡ï¼Œå½¢çŠ¶ä¸º [N, C, H, W]
            # - global_step: å½“å‰æ­¥æ•°ï¼Œç”¨äºåœ¨æ—¶é—´è½´ä¸Šå®šä½
            writer.add_images("Epoch:{}".format(epoch), imgs, step)
            step = step + 1

    # ========================================================================
    # 6. æ¸…ç†èµ„æº
    # ========================================================================
    writer.close()  # å…³é—­ SummaryWriterï¼Œç¡®ä¿æ•°æ®è¢«å†™å…¥ç£ç›˜
    print("âœ… å®Œæˆï¼è¯·è¿è¡Œ: tensorboard --logdir=dataloader æŸ¥çœ‹ç»“æœ")


if __name__ == "__main__":
    main()
